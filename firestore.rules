rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAdmin() {
      return request.auth.token.email == 'admin@buslink.com' || 
             (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    function isConductor() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'conductor';
    }

    // User Profiles
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Subcollections (favorite_routes, etc.)
      match /{document=**} {
        allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }
    
    // Trips (Public read, admins/conductors can edit everything, Users can ONLY update seat numbers)
    match /trips/{tripId} {
      allow read: if true;
      allow update: if isAdmin() || isConductor() || 
                    (request.auth != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bookedSeatNumbers', 'blockedSeats']));
      allow create, delete: if isAdmin();
    }

    // Routes (Public read, admin write)
    match /routes/{routeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Schedules (Public read, admin write)
    match /schedules/{scheduleId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Feedback (Authenticated users can submit, admins can read)
    match /feedback/{feedbackId} {
      allow create: if request.auth != null;
      allow read: if isAdmin();
    }

    // Tickets (Users own their tickets, admins/conductors can view/cancel)
    match /tickets/{ticketId} {
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin() || isConductor());
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Users can't update tickets (only admins/conductors can cancel/refund)
      allow update: if isAdmin() || isConductor();
    }

    // Refunds (Users create their own, admins approve/reject)
    match /refunds/{refundId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin()); 
      allow update: if isAdmin();
    }

    // Refund Transactions (Admin only)
    match /refund_transactions/{txnId} {
      allow read, write: if isAdmin();
    }

    // Notifications (Users create/read their own, admins can create for anyone)
    match /notifications/{notificationId} {
      allow create: if request.auth != null && (
          request.resource.data.userId == request.auth.uid || 
          isAdmin()
      );
      allow read, update: if request.auth != null && (
          resource.data.userId == request.auth.uid || 
          isAdmin()
      );
    }
  }
}
